<!DOCTYPE html>
<html>

<head>
    <title>Smart Ambulance Routing - ResQAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial;
        }

        .navbar {
            background: #1F2937;
            color: white;
            padding: 12px 20px;
        }

        .header-section {
            padding: 15px;
            background: #f3f4f6;
        }

        .control-bar {
            padding: 15px;
            text-align: center;
            background: white;
        }

        .control-btn {
            padding: 10px 18px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .primary {
            background: #DC2626;
            color: white;
        }

        .secondary {
            background: #e5e7eb;
        }

        .map-container {
            height: 70vh;
            position: relative;
        }

        #map {
            height: 100%;
        }

        .status-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 500;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            background: green;
        }

        .status-indicator.rerouting {
            background: orange;
        }

        .status-indicator.alert {
            background: red;
        }
    </style>
</head>

<body>

    <div class="navbar">
        üöë <b>ResQAI - Smart Live Routing</b>
    </div>

    <div class="header-section">
        <b>Original ETA:</b> {{ eta_original }} mins |
        <b>Current ETA:</b> <span id="etaNew">{{ eta_original }}</span> mins
    </div>

    <div class="control-bar">
        <button class="control-btn primary" onclick="injectTraffic()" id="trafficBtn">
            üöß Inject Traffic
        </button>

        <button class="control-btn secondary" onclick="toggleMovement()" id="pauseBtn">
            ‚è∏ Pause
        </button>

        <button class="control-btn secondary" onclick="resetSimulation()">
            üîÑ Reset
        </button>
    </div>

    <div class="map-container">
        <div class="status-badge" id="statusBadge">
            <span class="status-indicator active"></span>
            <span id="statusText">En Route</span>
        </div>
        <div id="map"></div>
    </div>

   <script>

var originalRoute = {{ original_route | tojson }};
var accident = [{{ accident_lat }}, {{ accident_lon }}];
var hospital = [{{ hospital_lat }}, {{ hospital_lon }}];

var map = L.map('map').setView(hospital, 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
}).addTo(map);

/* ---------- ICONS ---------- */

var hospitalIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1484/1484846.png",
    iconSize: [35, 35]
});

var ambulanceIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
    iconSize: [35, 35]
});

L.marker(hospital, { icon: hospitalIcon }).addTo(map);
L.marker(accident).addTo(map);

/* ---------- ROUTE DRAWING ---------- */

var originalLine = L.polyline(originalRoute, {
    color: '#3B82F6',
    weight: 6
}).addTo(map);

map.fitBounds(originalLine.getBounds());

/* Travelled path (RED) */
var travelledPath = [];
var travelledLine = L.polyline([], {
    color: '#DC2626',
    weight: 6
}).addTo(map);

/* Ambulance marker */
var ambulance = L.marker(originalRoute[0], {
    icon: ambulanceIcon
}).addTo(map);

/* ---------- MOVEMENT VARIABLES ---------- */

var animationInterval;
var currentIndex = 0;
var activeRoute = originalRoute;
var moving = true;
var rerouted = false;

/* ---------- START MOVEMENT ---------- */

function startMovement(speed = 200) {

    clearInterval(animationInterval);

    animationInterval = setInterval(function () {

        if (!moving) return;

        if (currentIndex >= activeRoute.length) {
            clearInterval(animationInterval);
            updateStatus('Arrived at Destination', 'active');
            alert("üöë Ambulance Reached Destination!");
            return;
        }

        var point = activeRoute[currentIndex];

        ambulance.setLatLng(point);
        map.panTo(point, { animate: true, duration: 0.3 });

        travelledPath.push(point);
        travelledLine.setLatLngs(travelledPath);

        currentIndex++;

    }, speed);
}

startMovement();

/* ---------- TRAFFIC INJECTION ---------- */

function injectTraffic() {

    if (rerouted) return;

    updateStatus('Heavy Traffic Ahead...', 'alert');

    // Slow down animation temporarily
    moving = true;
    startMovement(800);

    var currentLocation = ambulance.getLatLng();

    fetch("/dynamic_reroute", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            lat: currentLocation.lat,
            lon: currentLocation.lng,
            hospital_lat: hospital[0],
            hospital_lon: hospital[1]
        })
    })
    .then(res => res.json())
    .then(data => {

        clearInterval(animationInterval);

        // Draw new route (GREEN)
        L.polyline(data.new_route, {
            color: '#10B981',
            weight: 6
        }).addTo(map);

        document.getElementById("etaNew").innerHTML = data.eta;

        // Continue from current location on new path
        activeRoute = data.new_route;
        travelledPath = [];
        travelledLine.setLatLngs([]);

        currentIndex = 0;
        rerouted = true;

        updateStatus('Optimized Route Active', 'active');

        document.getElementById("trafficBtn").disabled = true;

        // Resume normal speed
        startMovement(200);
    })
    .catch(err => {
        console.error("Reroute error:", err);
        updateStatus('Reroute Failed', 'alert');
    });
}

/* ---------- PAUSE / RESUME ---------- */

function toggleMovement() {
    moving = !moving;

    const btn = document.getElementById('pauseBtn');

    if (moving) {
        btn.innerHTML = "‚è∏ Pause";
        updateStatus('En Route', 'active');
    } else {
        btn.innerHTML = "‚ñ∂ Resume";
        updateStatus('Paused', 'alert');
    }
}

/* ---------- RESET ---------- */

function resetSimulation() {
    location.reload();
}

/* ---------- STATUS ---------- */

function updateStatus(text, type) {
    const badge = document.getElementById('statusBadge');
    const indicator = badge.querySelector('.status-indicator');
    const statusText = document.getElementById('statusText');

    statusText.textContent = text;
    indicator.className = 'status-indicator ' + type;
}

</script>


</body>

</html>