<!DOCTYPE html>
<html>
<head>
    <title>Smart Ambulance Routing</title>

    <link rel="stylesheet"
        href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial;
            background: #0f172a;
            color: white;
            text-align: center;
        }

        #map {
            height: 85vh;
            width: 100%;
        }

        .info-box {
            padding: 10px;
            background: #1e293b;
            border-radius: 10px;
            display: inline-block;
            margin: 10px;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            background: #38bdf8;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background: #0ea5e9;
        }
    </style>
</head>
<body>

<h2>üöë Smart Ambulance Live Routing</h2>

<div class="info-box">
    ‚è± Original ETA: <b id="etaOriginal">{{ eta_original }} mins</b><br>
    ‚è± Current ETA: <b id="etaNew">{{ eta_original }} mins</b>
</div>

<br>
<button onclick="injectTraffic()">üöß Inject Traffic</button>

<div id="map"></div>

<script>

// ------------------ DATA FROM FLASK ------------------

var originalRoute = {{ original_route | tojson }};
var newRoute = {{ new_route | tojson }};
var accident = [{{ accident_lat }}, {{ accident_lon }}];
var hospital = [{{ hospital_lat }}, {{ hospital_lon }}];
var etaOriginal = {{ eta_original }};
var etaNew = {{ eta_new }};
var congestedEdges = {{ congested_edges | tojson }};

// ------------------ MAP INIT ------------------

var map = L.map('map').setView(hospital, 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬©Ô∏è OpenStreetMap'
}).addTo(map);

// ------------------ ICONS ------------------

var hospitalIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1484/1484846.png",
    iconSize: [35, 35]
});

var ambulanceIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
    iconSize: [35, 35]
});

// ------------------ MARKERS ------------------

L.marker(hospital, { icon: hospitalIcon })
    .addTo(map)
    .bindPopup("üè• Hospital");

L.marker(accident)
    .addTo(map)
    .bindPopup("üö® Accident");

// ------------------ DRAW ORIGINAL ROUTE ------------------

var originalLine = L.polyline(originalRoute, {
    color: 'blue',
    weight: 6
}).addTo(map);

map.fitBounds(originalLine.getBounds());

// ------------------ DRAW CONGESTED EDGES ------------------

congestedEdges.forEach(function(edge) {
    L.polyline(edge, {
        color: 'red',
        weight: 4,
        dashArray: "6,6"
    }).addTo(map);
});

// ------------------ AMBULANCE ------------------

var ambulance = L.marker(originalRoute[0], {
    icon: ambulanceIcon
}).addTo(map);

// ------------------ MOVEMENT ------------------

var animationInterval;
var currentIndex = 0;
var activeRoute = originalRoute;
var moving = true;
var rerouted = false;

function startMovement() {

    animationInterval = setInterval(function() {

        if (!moving) return;

        if (currentIndex >= activeRoute.length) {
            clearInterval(animationInterval);
            alert("üöë Ambulance Reached Destination!");
            return;
        }

        ambulance.setLatLng(activeRoute[currentIndex]);
        map.panTo(activeRoute[currentIndex], { animate: true, duration: 0.3 });

        currentIndex++;

    }, 200);
}

startMovement();

// ------------------ TRAFFIC INJECTION ------------------

function injectTraffic() {

    if (rerouted) return;

    alert("üöß Heavy Traffic Detected! AI Re-routing...");

    moving = false;

    // Remove original route
    if (originalLine) {
        map.removeLayer(originalLine);
    }

    // Draw new route
    L.polyline(newRoute, {
        color: 'green',
        weight: 6
    }).addTo(map);

    // Update ETA display
    document.getElementById("etaNew").innerHTML = etaNew + " mins";

    activeRoute = newRoute;
    currentIndex = 0;
    moving = true;
    rerouted = true;
}

</script>

</body>
</html>
